# this is the first big run on 7 layers, 3.4 sec a step, minibatches are now 64
# evaluation set is 400, takes 9 seconds for evaluations

Here is the model:

--------------------------------------------------------------------------------
Initial input shape: (None, 1, 726, 568)
--------------------------------------------------------------------------------
Layer (name)                  Output Shape                  Param #   kernel          
--------------------------------------------------------------------------------
Convolution2D (convolution2d) (None, 16, 726, 568)          2320      16,12,12          
Activation (activation)       (None, 16, 726, 568)          0                   
MaxPooling2D (maxpooling2d)   (None, 16, 181, 142)          0                   
BatchNormalization (batchnorma(None, 16, 181, 142)          32                  

Convolution2D (convolution2d) (None, 16, 181, 142)          36880     16,12,12          
Activation (activation)       (None, 16, 181, 142)          0                   
MaxPooling2D (maxpooling2d)   (None, 16, 45, 35)            0                   
BatchNormalization (batchnorma(None, 16, 45, 35)            32                  

Convolution2D (convolution2d) (None, 12, 45, 35)            19212     12,10,10           
Activation (activation)       (None, 12, 45, 35)            0                   
MaxPooling2D (maxpooling2d)   (None, 12, 11, 9)             0                   
BatchNormalization (batchnorma(None, 12, 11, 9)             24                  

Convolution2D (convolution2d) (None, 8, 11, 9)              1544       8,4,4  
Activation (activation)       (None, 8, 11, 9)              0                   
MaxPooling2D (maxpooling2d)   (None, 8, 5, 4)               0                   
BatchNormalization (batchnorma(None, 8, 5, 4)               16                  

Flatten (flatten)             (None, 160)                   0                   

Dense (dense)                 (None, 32)                    5152                
Activation (activation)       (None, 32)                    0                   
BatchNormalization (batchnorma(None, 32)                    64                  

Dense (dense)                 (None, 16)                    528                 
Activation (activation)       (None, 16)                    0                   
BatchNormalization (batchnorma(None, 16)                    32                  

Dense (dense)                 (None, 4)                     68                  
Activation (activation)       (None, 4)                     0                   
--------------------------------------------------------------------------------
Total params: 65904
--------------------------------------------------------------------------------
total time: 17158.15 = 4 hours, 45 minutes

Other parameters, 5000 steps, evaluations every 250 steps (epoch is 258).
optimizer: sgd = SGD(lr=0.01, momentum=0.96) with a learning rate schedule that
           applies 0.97 decay every 100 steps, with a min lr of 0.003

It got to 98% on the training data, but 78% on the test.

I think it is time to add regularization.

I looked a little more at the final evaluation confusion matrix, 
(rows are truth, columns are predicted) and the accuracy per class is about the same.
Here are wrong predictions:

0 = 13/(80.0)                  = 0.16
1 = (5+1+8)/float(33+5+1+8)    = 0.30
2 = (3+1+25)/float(3+1+116+25) = 0.20
3 = (3+9+20)/float(3+9+20+96)  = 0.25

Other notes, I preload the data and preprocess is with log/mean - 25GB, leave it 
in ram while I keep fiddling with the script and re-running it.

I re-shuffle the data with each epoch, each minibatch is a new random sample

Here's some startup about the data. I set the balance ratio to 2.3 to process more
data - processing 17k images now:

H5MiniBatchReader: set random_seed to 23432
Scanning through h5 files ...
total of 66153 samples in 133 files, 37978 for this dataset (57%)
  label=  0 has 3744 samples (10%)
  label=  1 has 2355 samples (6%)
  label=  2 has 16390 samples (43%)
  label=  3 has 15489 samples (41%)
... scan took 1.84 sec
After balancing per ratio 2.30, there are 16933 examples
   label=  0       3744 examples  ( 22.1% of dataset)
   label=  1       2355 examples  ( 13.9% of dataset)
   label=  2       5417 examples  ( 32.0% of dataset)
   label=  3       5417 examples  ( 32.0% of dataset)
classifier that always picks label for largest class performs at: 32.0%
not using 21 samples
Read 400 test samples in 6.21 sec
starting to preload 25974.35MB of data. preprocess steps=['log', 'mean'] ...


keras_convnet: datareader - 258 batches per epoch
starting to build and compile keras/theano model...
building/compiling theano model took 25.75 sec
 epch:mb | tm.s | loss.tr | acc.tr/ batch | acc.ev | learn.rt| confuse mat tr | confuse mat eva  | tm.e
  0: 250 |  3.4 |    0.69 |   0.67/  0.72 |   0.79 | 0.00941 |  14   0   0   0 |  67   7   0   6 |   9.0
                                                             |   3   4   0   3 |   3  37   0   7 |
                                                             |   0   0  11   6 |   5   1 108  31 |
                                                             |   1   4   1  17 |   2   7  16 103 |
---------------------------------------------------------------------------------------------------
  1: 242 |  3.4 |    0.45 |   0.83/  0.84 |   0.80 | 0.00859 |  15   0   0   1 |  71   5   0   4 |   9.0
                                                             |   1  11   0   1 |   4  37   0   6 |
                                                             |   0   0  12   3 |   7   0 111  27 |
                                                             |   1   3   0  16 |   2  13  13 100 |
---------------------------------------------------------------------------------------------------
  2: 234 |  3.4 |    0.48 |   0.80/  0.88 |   0.81 | 0.00808 |  12   0   0   1 |  66  11   0   3 |   9.0
                                                             |   0   6   0   1 |   2  41   0   4 |
                                                             |   0   0  14   5 |   2   1 107  35 |
                                                             |   0   0   1  24 |   1   7  12 108 |
---------------------------------------------------------------------------------------------------
  3: 226 |  3.4 |    0.27 |   0.89/  0.89 |   0.80 | 0.00737 |  14   2   0   0 |  67   8   0   5 |   9.0
                                                             |   0   6   0   1 |   2  34   0  11 |
                                                             |   0   0  21   2 |   2   1 114  28 |
                                                             |   0   2   0  16 |   0   5  19 104 |
---------------------------------------------------------------------------------------------------
  4: 218 |  3.4 |    0.40 |   0.89/  0.88 |   0.80 | 0.00694 |  13   0   0   0 |  76   0   1   3 |   9.0
                                                             |   2   6   0   0 |  13  26   0   8 |
                                                             |   0   0  18   1 |   7   0 124  14 |
                                                             |   2   0   3  19 |   4   4  26  94 |
---------------------------------------------------------------------------------------------------
  5: 210 |  3.4 |    0.36 |   0.88/  0.88 |   0.79 | 0.00633 |  15   0   0   0 |  70   2   1   7 |   9.0
                                                             |   3   5   0   1 |   5  35   0   7 |
                                                             |   0   0  20   1 |   4   0 112  29 |
                                                             |   0   0   3  16 |   2  11  15 100 |
---------------------------------------------------------------------------------------------------
  6: 202 |  3.4 |    0.48 |   0.80/  0.75 |   0.83 | 0.00596 |  11   1   0   0 |  70   6   0   4 |   9.0
                                                             |   1   5   0   1 |   4  39   0   4 |
                                                             |   2   0  19   3 |   4   1 122  18 |
                                                             |   0   6   2  13 |   1   8  19 100 |
---------------------------------------------------------------------------------------------------
  7: 194 |  3.4 |    0.41 |   0.81/  0.86 |   0.80 | 0.00544 |  13   1   0   0 |  73   4   0   3 |   9.0
                                                             |   2   7   0   0 |   6  36   0   5 |
                                                             |   2   0  16   2 |   7   2 107  29 |
                                                             |   0   1   1  19 |   3   9  13 103 |
---------------------------------------------------------------------------------------------------
  8: 186 |  3.4 |    0.36 |   0.83/  0.83 |   0.78 | 0.00512 |  14   1   0   0 |  76   2   0   2 |   9.0
                                                             |   1   2   0   1 |  13  32   0   2 |
                                                             |   1   0  22   0 |   9   0 123  13 |
                                                             |   1   2   4  15 |   7  10  31  80 |
---------------------------------------------------------------------------------------------------
  9: 178 |  3.4 |    0.50 |   0.81/  0.86 |   0.79 | 0.00467 |   7   0   0   0 |  71   4   0   5 |   9.0
                                                             |   2  11   0   0 |   4  37   0   6 |
                                                             |   1   0  18   1 |   4   2 114  25 |
                                                             |   0   4   1  19 |   3  10  20  95 |
---------------------------------------------------------------------------------------------------
 10: 170 |  3.4 |    0.37 |   0.83/  0.83 |   0.79 | 0.00439 |  13   0   0   0 |  73   2   0   5 |   9.0
                                                             |   2   8   0   2 |   7  34   0   6 |
                                                             |   1   0  18   3 |   6   1 108  30 |
                                                             |   0   2   1  14 |   1  10  16 101 |
---------------------------------------------------------------------------------------------------
 11: 162 |  3.4 |    0.28 |   0.91/  0.95 |   0.76 | 0.00401 |  18   0   0   0 |  72   5   0   3 |   9.0
                                                             |   0   4   0   0 |   9  32   0   6 |
                                                             |   0   0  19   1 |   7   1 118  19 |
                                                             |   1   1   0  20 |   5  13  28  82 |
---------------------------------------------------------------------------------------------------
 12: 154 |  3.4 |    0.29 |   0.89/  0.91 |   0.76 | 0.00377 |  17   0   0   0 |  75   2   0   3 |   9.0
                                                             |   1   8   0   1 |   9  34   1   3 |
                                                             |   1   0  16   1 |   8   1 117  19 |
                                                             |   0   1   1  17 |   3  10  36  79 |
---------------------------------------------------------------------------------------------------
 13: 146 |  3.4 |    0.21 |   0.92/  0.94 |   0.76 | 0.00344 |  20   0   0   0 |  72   4   0   4 |   9.0
                                                             |   1   7   0   0 |   9  32   0   6 |
                                                             |   0   0  16   1 |   6   1 114  24 |
                                                             |   0   1   1  17 |   3  11  27  87 |
---------------------------------------------------------------------------------------------------
 14: 138 |  3.4 |    0.16 |   0.92/  0.95 |   0.77 | 0.00324 |  14   0   0   0 |  71   6   0   3 |   9.0
                                                             |   0   9   0   0 |  11  31   0   5 |
                                                             |   1   0  24   0 |   7   1 115  22 |
                                                             |   1   1   0  14 |   4  10  24  90 |
---------------------------------------------------------------------------------------------------
 15: 130 |  3.4 |    0.08 |   0.98/  0.98 |   0.76 | 0.00296 |  17   0   0   0 |  66   8   1   5 |   9.0
                                                             |   0   9   0   0 |   6  32   0   9 |
                                                             |   0   0  14   1 |   3   3 114  25 |
                                                             |   0   0   0  23 |   2   8  28  90 |
---------------------------------------------------------------------------------------------------
 16: 122 |  3.4 |    0.06 |   0.98/  0.98 |   0.76 | 0.00296 |  19   0   0   0 |  71   3   1   5 |   9.0
                                                             |   1   7   0   0 |   9  32   0   6 |
                                                             |   0   0  18   0 |   7   1 116  21 |
                                                             |   0   0   0  19 |   3  10  31  84 |
---------------------------------------------------------------------------------------------------
 17: 114 |  3.4 |    0.10 |   0.95/  1.00 |   0.75 | 0.00296 |  15   0   0   0 |  70   6   0   4 |   9.0
                                                             |   0  13   0   0 |   8  33   0   6 |
                                                             |   0   0  22   0 |   6   2 109  28 |
                                                             |   0   0   0  14 |   4  10  25  89 |
---------------------------------------------------------------------------------------------------
 18: 106 |  3.4 |    0.05 |   0.98/  0.98 |   0.77 | 0.00296 |  16   0   0   0 |  67   7   1   5 |   9.0
                                                             |   0   9   0   0 |   6  36   0   5 |
                                                             |   0   0  23   0 |   5   2 117  21 |
                                                             |   0   1   0  15 |   5  11  25  87 |
---------------------------------------------------------------------------------------------------
 19:  98 |  3.4 |    0.09 |   0.97/  0.98 |   0.78 | 0.00296 |  13   0   0   0 |  67   6   1   6 |   9.0
                                                             |   1  10   0   0 |   5  33   1   8 |
                                                             |   0   0  17   0 |   3   1 116  25 |
                                                             |   0   0   0  23 |   3   9  20  96 |
---------------------------------------------------------------------------------------------------
type q to quit, or anything else to rerun script keras_convnet.py
